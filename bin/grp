#!/usr/bin/env ruby

require "commander/import"
require "fileutils"

include FileUtils

GARPO_DIR = ".garpo"

program :name,        "Garpo"
program :description, "Cirpo's Version Control System"
program :version,     "0.0"

command :init do |c|
  c.syntax = "grp init"
  c.description = "Initialize a Garpo repository"
  c.when_called do |args, options|
    mkdir GARPO_DIR
    say_ok "Garpo initialized"
  end
end

command :commit do |c|
  c.syntax = "grp commit"
  c.description = "Commit a directory shapshot to Garpo"
  c.when_called do |args, options|
    greatest_snapshot = Dir.glob("#{GARPO_DIR}/snapshot-*").map {|s| s[/\d+/].to_i}.max || 0
    this_snapshot = greatest_snapshot + 1
    snapshot_dir = "#{GARPO_DIR}/snapshot-#{this_snapshot}"
    mkdir snapshot_dir
    cp_r Dir.entries(".") - [".", "..", GARPO_DIR], snapshot_dir
    say_ok "Garpo committed snapshot #{this_snapshot}"
  end
end
